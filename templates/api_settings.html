{% extends "base.html" %}

{% block title %}API Settings - MyHub{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4 mb-0 fw-bold"><i class="bi bi-code-slash text-primary me-2"></i>API Keys</h1>
</div>

<div class="card mb-4">
    <div class="card-header">Generate New API Key</div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('api_key_generate') }}" class="row g-3 align-items-end">
            <div class="col-auto flex-grow-1">
                <label for="name" class="form-label">Key Name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="e.g., n8n Integration, Zapier" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i> Generate Key</button>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">Your API Keys</div>
    <div class="card-body p-0">
        {% if keys %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Key</th>
                        <th>Created</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in keys %}
                    <tr>
                        <td><strong>{{ key.name or 'Unnamed' }}</strong></td>
                        <td>
                            <code class="user-select-all">{{ key.key[:8] }}...{{ key.key[-8:] }}</code>
                            <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyToClipboard('{{ key.key }}')" title="Copy full key">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </td>
                        <td class="text-muted">{{ key.created_at.strftime('%b %d, %Y') }}</td>
                        <td class="text-end">
                            <form action="{{ url_for('api_key_delete', id=key.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Revoke this API key? Any integrations using it will stop working.')">
                                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> Revoke</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-key"></i>
            <p>No API keys generated yet</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">API Documentation</div>
    <div class="card-body">
        <h6>Add Income via API</h6>
        <p class="text-muted mb-3">Use this endpoint to add income from external tools like n8n, Zapier, or custom scripts.</p>

        <div class="mb-3">
            <label class="form-label">Endpoint</label>
            <code class="d-block p-2 rounded" style="background: var(--bg-tertiary);">POST /api/v1/income</code>
        </div>

        <div class="mb-3">
            <label class="form-label">Headers</label>
            <pre class="p-2 rounded mb-0" style="background: var(--bg-tertiary); color: var(--text-primary);">Content-Type: application/json
X-API-Key: your-api-key-here</pre>
        </div>

        <div class="mb-3">
            <label class="form-label">Request Body</label>
            <pre class="p-2 rounded mb-0" style="background: var(--bg-tertiary); color: var(--text-primary);">{
  "name": "Freelance Project",
  "amount": 500.00,
  "folder": "Savings",        // optional, auto-creates if not exists
  "client": "Client Name",    // optional, auto-creates if not exists
  "date": "2024-01-15",       // optional, defaults to today
  "notes": "Payment for..."   // optional
}</pre>
        </div>

        <div class="mb-3">
            <label class="form-label">Success Response</label>
            <pre class="p-2 rounded mb-0" style="background: var(--bg-tertiary); color: var(--accent-success);">{
  "success": true,
  "income_id": 123,
  "message": "Income added successfully"
}</pre>
        </div>

        <div>
            <label class="form-label">Example cURL</label>
            <pre class="p-2 rounded mb-0" style="background: var(--bg-tertiary); color: var(--text-primary);">curl -X POST {{ request.host_url }}api/v1/income \
  -H "Content-Type: application/json" \
  -H "X-API-Key: YOUR_KEY" \
  -d '{"name": "Test Income", "amount": 100}'</pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('API key copied to clipboard!');
    });
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-5 px-4 py-2 rounded';
    toast.style.cssText = 'z-index: 9999; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}
</script>
{% endblock %}
