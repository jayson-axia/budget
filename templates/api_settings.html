{% extends "base.html" %}

{% block title %}API Settings - BudgetQuest{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4 mb-0 fw-bold"><i class="bi bi-code-slash me-2" style="color: var(--neon-blue);"></i>API Keys</h1>
</div>

<p class="text-muted mb-4">Connect external tools like n8n, Zapier, or custom scripts to your BudgetQuest.</p>

<div class="game-card mb-4">
    <div class="game-card-header">
        <i class="bi bi-key me-2"></i>Generate New API Key
    </div>
    <div class="game-card-body">
        <form method="POST" action="{{ url_for('api_key_generate') }}" class="row g-3 align-items-end">
            <div class="col-auto flex-grow-1">
                <label for="name" class="form-label">Key Name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="e.g., n8n Integration, Zapier" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-game"><i class="bi bi-plus-lg me-1"></i> Generate Key</button>
            </div>
        </form>
    </div>
</div>

<div class="game-card mb-4">
    <div class="game-card-header">
        <i class="bi bi-list-ul me-2"></i>Your API Keys
    </div>
    <div class="game-card-body p-0">
        {% if keys %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Key</th>
                        <th>Created</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in keys %}
                    <tr>
                        <td><strong>{{ key.name or 'Unnamed' }}</strong></td>
                        <td>
                            <code class="user-select-all" style="color: var(--neon-green);">{{ key.key[:8] }}...{{ key.key[-8:] }}</code>
                            <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyToClipboard('{{ key.key }}')" title="Copy full key" style="color: var(--neon-blue);">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </td>
                        <td class="text-muted">{{ key.created_at.strftime('%b %d, %Y') }}</td>
                        <td class="text-end">
                            <form action="{{ url_for('api_key_delete', id=key.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Revoke this API key? Any integrations using it will stop working.')">
                                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash me-1"></i> Revoke</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-key"></i>
            <p class="text-muted mt-3">No API keys generated yet</p>
            <p class="text-muted small">Create a key to connect external tools!</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="game-card mb-4">
    <div class="game-card-header">
        <i class="bi bi-book me-2"></i>API Documentation
    </div>
    <div class="game-card-body">
        <p class="text-muted mb-4">All endpoints require the <code style="color: var(--neon-blue);">X-API-Key</code> header with your API key.</p>

        <!-- Add Income -->
        <div class="mb-4 pb-4" style="border-bottom: 1px solid var(--border-color);">
            <h6 style="color: var(--neon-green);"><i class="bi bi-arrow-up-circle me-2"></i>Add Income</h6>
            <code class="d-block p-2 rounded mb-3" style="background: rgba(0, 255, 136, 0.1); color: var(--neon-green); border: 1px solid rgba(0, 255, 136, 0.2);">POST /api/v1/income</code>
            <table class="table table-sm mb-3">
                <thead><tr><th>Field</th><th>Required</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td><code>name</code></td><td>Yes</td><td>Income source name</td></tr>
                    <tr><td><code>amount</code></td><td>Yes</td><td>Amount (number)</td></tr>
                    <tr><td><code>date</code></td><td>No</td><td>YYYY-MM-DD (defaults to today)</td></tr>
                    <tr><td><code>category</code></td><td>No</td><td>Category name (auto-creates)</td></tr>
                    <tr><td><code>client</code></td><td>No</td><td>Client name (auto-creates)</td></tr>
                    <tr><td><code>notes</code></td><td>No</td><td>Additional notes</td></tr>
                </tbody>
            </table>
            <pre class="p-2 rounded mb-0" style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.8rem;">curl -X POST {{ request.host_url }}api/v1/income \
  -H "Content-Type: application/json" \
  -H "X-API-Key: YOUR_KEY" \
  -d '{"name": "Salary", "amount": 50000}'</pre>
        </div>

        <!-- Add Expense -->
        <div class="mb-4 pb-4" style="border-bottom: 1px solid var(--border-color);">
            <h6 style="color: var(--neon-red);"><i class="bi bi-arrow-down-circle me-2"></i>Add Expense</h6>
            <code class="d-block p-2 rounded mb-3" style="background: rgba(255, 71, 87, 0.1); color: var(--neon-red); border: 1px solid rgba(255, 71, 87, 0.2);">POST /api/v1/expense</code>
            <table class="table table-sm mb-3">
                <thead><tr><th>Field</th><th>Required</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td><code>name</code></td><td>Yes</td><td>Expense description</td></tr>
                    <tr><td><code>amount</code></td><td>Yes</td><td>Amount (number)</td></tr>
                    <tr><td><code>date</code></td><td>No</td><td>YYYY-MM-DD (defaults to today)</td></tr>
                    <tr><td><code>category</code></td><td>No</td><td>Category name (auto-creates)</td></tr>
                    <tr><td><code>notes</code></td><td>No</td><td>Additional notes</td></tr>
                </tbody>
            </table>
            <pre class="p-2 rounded mb-0" style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.8rem;">curl -X POST {{ request.host_url }}api/v1/expense \
  -H "Content-Type: application/json" \
  -H "X-API-Key: YOUR_KEY" \
  -d '{"name": "Groceries", "amount": 1500, "category": "Food"}'</pre>
        </div>

        <!-- Add Bank Account -->
        <div class="mb-4 pb-4" style="border-bottom: 1px solid var(--border-color);">
            <h6 style="color: var(--neon-purple);"><i class="bi bi-bank me-2"></i>Add Bank Account</h6>
            <code class="d-block p-2 rounded mb-3" style="background: rgba(168, 85, 247, 0.1); color: var(--neon-purple); border: 1px solid rgba(168, 85, 247, 0.2);">POST /api/v1/bank</code>
            <table class="table table-sm mb-3">
                <thead><tr><th>Field</th><th>Required</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td><code>name</code></td><td>Yes</td><td>Bank/account name</td></tr>
                    <tr><td><code>balance</code></td><td>No</td><td>Initial balance (defaults to 0)</td></tr>
                    <tr><td><code>icon</code></td><td>No</td><td>Icon name (defaults to "bank")</td></tr>
                    <tr><td><code>color</code></td><td>No</td><td>Hex color (defaults to #6366f1)</td></tr>
                    <tr><td><code>notes</code></td><td>No</td><td>Additional notes</td></tr>
                </tbody>
            </table>
            <pre class="p-2 rounded mb-0" style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.8rem;">curl -X POST {{ request.host_url }}api/v1/bank \
  -H "Content-Type: application/json" \
  -H "X-API-Key: YOUR_KEY" \
  -d '{"name": "BDO Savings", "balance": 50000}'</pre>
        </div>

        <!-- List Banks -->
        <div class="mb-4 pb-4" style="border-bottom: 1px solid var(--border-color);">
            <h6 style="color: var(--neon-blue);"><i class="bi bi-list-ul me-2"></i>List Bank Accounts</h6>
            <code class="d-block p-2 rounded mb-3" style="background: rgba(0, 212, 255, 0.1); color: var(--neon-blue); border: 1px solid rgba(0, 212, 255, 0.2);">GET /api/v1/banks</code>
            <p class="text-muted small mb-2">Returns all your bank accounts with their IDs and balances.</p>
            <pre class="p-2 rounded mb-0" style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.8rem;">curl {{ request.host_url }}api/v1/banks \
  -H "X-API-Key: YOUR_KEY"</pre>
        </div>

        <!-- Adjust Balance -->
        <div>
            <h6 style="color: var(--neon-yellow);"><i class="bi bi-plus-slash-minus me-2"></i>Adjust Bank Balance</h6>
            <code class="d-block p-2 rounded mb-3" style="background: rgba(255, 217, 61, 0.1); color: var(--neon-yellow); border: 1px solid rgba(255, 217, 61, 0.2);">POST /api/v1/bank/{id}/adjust</code>
            <table class="table table-sm mb-3">
                <thead><tr><th>Field</th><th>Required</th><th>Description</th></tr></thead>
                <tbody>
                    <tr><td><code>amount</code></td><td>Yes</td><td>Positive to add, negative to subtract</td></tr>
                </tbody>
            </table>
            <p class="text-muted small mb-2">Get the bank ID from the "List Banks" endpoint.</p>
            <pre class="p-2 rounded mb-2" style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.8rem;"># Add 1000 to bank ID 1
curl -X POST {{ request.host_url }}api/v1/bank/1/adjust \
  -H "Content-Type: application/json" \
  -H "X-API-Key: YOUR_KEY" \
  -d '{"amount": 1000}'</pre>
            <pre class="p-2 rounded mb-0" style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 0.8rem;"># Subtract 500 from bank ID 1
curl -X POST {{ request.host_url }}api/v1/bank/1/adjust \
  -H "Content-Type: application/json" \
  -H "X-API-Key: YOUR_KEY" \
  -d '{"amount": -500}'</pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('API key copied to clipboard!');
    });
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-5 px-4 py-2 rounded';
    toast.style.cssText = 'z-index: 9999; background: var(--card-bg); color: var(--neon-green); border: 1px solid var(--neon-green); box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}
</script>
{% endblock %}
