{% extends "base.html" %}

{% block title %}API Settings - BudgetQuest{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4 mb-0 fw-bold"><i class="bi bi-code-slash me-2" style="color: var(--neon-blue);"></i>API Keys</h1>
</div>

<p class="text-muted mb-4">Connect external tools like n8n, Zapier, or custom scripts to your BudgetQuest.</p>

<div class="game-card mb-4">
    <div class="game-card-header">
        <i class="bi bi-key me-2"></i>Generate New API Key
    </div>
    <div class="game-card-body">
        <form method="POST" action="{{ url_for('api_key_generate') }}" class="row g-3 align-items-end">
            <div class="col-auto flex-grow-1">
                <label for="name" class="form-label">Key Name</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="e.g., n8n Integration, Zapier" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-game"><i class="bi bi-plus-lg me-1"></i> Generate Key</button>
            </div>
        </form>
    </div>
</div>

<div class="game-card mb-4">
    <div class="game-card-header">
        <i class="bi bi-list-ul me-2"></i>Your API Keys
    </div>
    <div class="game-card-body p-0">
        {% if keys %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Key</th>
                        <th>Created</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in keys %}
                    <tr>
                        <td><strong>{{ key.name or 'Unnamed' }}</strong></td>
                        <td>
                            <code class="user-select-all" style="color: var(--neon-green);">{{ key.key[:8] }}...{{ key.key[-8:] }}</code>
                            <button class="btn btn-sm btn-link p-0 ms-2" onclick="copyToClipboard('{{ key.key }}')" title="Copy full key" style="color: var(--neon-blue);">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </td>
                        <td class="text-muted">{{ key.created_at.strftime('%b %d, %Y') }}</td>
                        <td class="text-end">
                            <form action="{{ url_for('api_key_delete', id=key.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Revoke this API key? Any integrations using it will stop working.')">
                                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash me-1"></i> Revoke</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-key"></i>
            <p class="text-muted mt-3">No API keys generated yet</p>
            <p class="text-muted small">Create a key to connect external tools!</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="game-card">
    <div class="game-card-header">
        <i class="bi bi-book me-2"></i>API Documentation
    </div>
    <div class="game-card-body">
        <h6 style="color: var(--neon-green);"><i class="bi bi-arrow-up-circle me-2"></i>Add Income via API</h6>
        <p class="text-muted mb-3">Use this endpoint to add income from external tools like n8n, Zapier, or custom scripts.</p>

        <div class="mb-3">
            <label class="form-label small text-muted">Endpoint</label>
            <code class="d-block p-2 rounded" style="background: rgba(0, 255, 136, 0.1); color: var(--neon-green); border: 1px solid rgba(0, 255, 136, 0.2);">POST /api/v1/income</code>
        </div>

        <div class="mb-3">
            <label class="form-label small text-muted">Headers</label>
            <pre class="p-2 rounded mb-0" style="background: var(--card-bg); border: 1px solid var(--card-border); color: #fff;">Content-Type: application/json
X-API-Key: your-api-key-here</pre>
        </div>

        <div class="mb-3">
            <label class="form-label small text-muted">Request Body</label>
            <pre class="p-2 rounded mb-0" style="background: var(--card-bg); border: 1px solid var(--card-border); color: #fff;">{
  "name": "Freelance Project",
  "amount": 500.00,
  "category": "Freelance",      // optional, auto-creates if not exists
  "client": "Client Name",      // optional, auto-creates if not exists
  "date": "2024-01-15",         // optional, defaults to today
  "notes": "Payment for..."     // optional
}</pre>
        </div>

        <div class="mb-3">
            <label class="form-label small text-muted">Success Response</label>
            <pre class="p-2 rounded mb-0" style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); color: var(--neon-green);">{
  "success": true,
  "income_id": 123,
  "message": "Income added successfully"
}</pre>
        </div>

        <div>
            <label class="form-label small text-muted">Example cURL</label>
            <pre class="p-2 rounded mb-0" style="background: var(--card-bg); border: 1px solid var(--card-border); color: var(--neon-blue);">curl -X POST {{ request.host_url }}api/v1/income \
  -H "Content-Type: application/json" \
  -H "X-API-Key: YOUR_KEY" \
  -d '{"name": "Test Income", "amount": 100}'</pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('API key copied to clipboard!');
    });
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 start-50 translate-middle-x mb-5 px-4 py-2 rounded';
    toast.style.cssText = 'z-index: 9999; background: var(--card-bg); color: var(--neon-green); border: 1px solid var(--neon-green); box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}
</script>
{% endblock %}
