{% extends "base.html" %}

{% block title %}Budgets - LifeQuest{% endblock %}

{% block extra_css %}
<style>
    .budget-progress {
        height: 12px;
        background: var(--bg-hover);
        border-radius: 6px;
        overflow: hidden;
    }
    .budget-progress-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.5s ease;
    }
    .budget-progress-fill.ok {
        background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }
    .budget-progress-fill.warning {
        background: linear-gradient(90deg, var(--neon-yellow), #ff8c00);
        box-shadow: 0 0 10px rgba(255, 217, 61, 0.3);
    }
    .budget-progress-fill.danger {
        background: linear-gradient(90deg, var(--neon-red), #cc3344);
        box-shadow: 0 0 10px rgba(255, 71, 87, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 page-header-flex">
    <h1 class="h4 mb-0 fw-bold">
        <i class="bi bi-speedometer2 me-2" style="color: var(--neon-yellow);"></i>Budgets
    </h1>
    <div class="d-flex align-items-center gap-2">
        <a href="{{ url_for('budget_list', year=prev_year, month=prev_month) }}" class="btn btn-outline-game btn-sm">
            <i class="bi bi-chevron-left"></i>
        </a>
        <span class="fw-bold" style="font-family: 'Orbitron', sans-serif; color: var(--neon-blue); min-width: 120px; text-align: center;">{{ month_name }}</span>
        <a href="{{ url_for('budget_list', year=next_year, month=next_month) }}" class="btn btn-outline-game btn-sm">
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>
</div>

<!-- Set Budget Form -->
<div class="game-card mb-4">
    <div class="game-card-header"><i class="bi bi-plus-circle me-2"></i>Set Monthly Budget</div>
    <div class="game-card-body">
        <form method="POST" action="{{ url_for('budget_set') }}">
            <input type="hidden" name="month" value="{{ month }}">
            <input type="hidden" name="year" value="{{ year }}">
            <div class="row g-3 align-items-end">
                <div class="col-12 col-md-5">
                    <label class="form-label">Category</label>
                    <select name="category_id" class="form-select" required>
                        <option value="">Select category</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}">{{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label">Monthly Limit</label>
                    <div class="input-group">
                        <span class="input-group-text">{{ currency_symbol }}</span>
                        <input type="number" step="0.01" min="0.01" name="monthly_limit" class="form-control" required placeholder="0.00">
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <button type="submit" class="btn btn-game w-100">
                        <i class="bi bi-check-lg me-1"></i> Set Budget
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Budget Progress Cards -->
{% for item in budget_data %}
<div class="game-card mb-3">
    <div class="game-card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="d-flex align-items-center gap-2">
                <span class="category-pill" style="background: {{ item.budget.category.color }}20; color: {{ item.budget.category.color }};">
                    <i class="bi bi-{{ item.budget.category.icon }}"></i> {{ item.budget.category.name }}
                </span>
            </div>
            <div class="d-flex align-items-center gap-2">
                <div class="text-end">
                    <span class="amount {% if item.status == 'danger' %}amount-expense{% elif item.status == 'warning' %}{% else %}amount-income{% endif %}">
                        {{ currency_symbol }}{{ "%.2f"|format(item.spent) }}
                    </span>
                    <span class="text-muted"> / {{ currency_symbol }}{{ "%.2f"|format(item.budget.monthly_limit) }}</span>
                </div>
                <form action="{{ url_for('budget_delete', id=item.budget.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Remove this budget?')">
                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                </form>
            </div>
        </div>
        <div class="budget-progress">
            <div class="budget-progress-fill {{ item.status }}" style="width: {{ item.percentage }}%;"></div>
        </div>
        <div class="d-flex justify-content-between mt-1">
            <small class="text-muted">{{ "%.0f"|format(item.raw_percentage) }}% used</small>
            <small class="{% if item.remaining >= 0 %}text-muted{% else %}amount-expense{% endif %}">
                {% if item.remaining >= 0 %}
                    {{ currency_symbol }}{{ "%.2f"|format(item.remaining) }} remaining
                {% else %}
                    {{ currency_symbol }}{{ "%.2f"|format(item.remaining|abs) }} over budget!
                {% endif %}
            </small>
        </div>
    </div>
</div>
{% endfor %}

{% if not budget_data %}
<div class="game-card">
    <div class="empty-state">
        <i class="bi bi-speedometer2"></i>
        <p class="text-muted mt-3">No budgets set for {{ month_name }}</p>
        <p class="text-muted small">Set spending limits above to track your budget!</p>
    </div>
</div>
{% endif %}
{% endblock %}
