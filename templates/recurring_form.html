{% extends "base.html" %}

{% block title %}{{ 'Edit' if rec else 'Add' }} Recurring - LifeQuest{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 page-header-flex">
    <h1 class="h4 mb-0 fw-bold">
        <i class="bi bi-arrow-repeat me-2" style="color: var(--neon-blue);"></i>{{ 'Edit' if rec else 'Add' }} Recurring Transaction
    </h1>
    <a href="{{ url_for('recurring_list') }}" class="btn btn-outline-game"><i class="bi bi-arrow-left me-1"></i> Back</a>
</div>

<div class="game-card" style="max-width: 600px;">
    <div class="game-card-body">
        <form method="POST">
            <div class="mb-3">
                <label class="form-label">Type</label>
                <div class="d-flex gap-2">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="type" id="type_income" value="income"
                            {{ 'checked' if rec and rec.type == 'income' else 'checked' if not rec else '' }}
                            onchange="toggleType()">
                        <label class="form-check-label" for="type_income">Income</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="type" id="type_expense" value="expense"
                            {{ 'checked' if rec and rec.type == 'expense' else '' }}
                            onchange="toggleType()">
                        <label class="form-check-label" for="type_expense">Expense</label>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <input type="text" name="description" class="form-control" required
                    value="{{ rec.description if rec else '' }}" placeholder="e.g., Monthly rent, Salary">
            </div>

            <div class="mb-3">
                <label class="form-label">Amount</label>
                <div class="input-group">
                    <span class="input-group-text">{{ currency_symbol }}</span>
                    <input type="number" step="0.01" min="0.01" name="amount" class="form-control" required
                        value="{{ rec.amount if rec else '' }}" placeholder="0.00">
                </div>
            </div>

            <div class="mb-3" id="income-category-group">
                <label class="form-label">Category</label>
                <select name="category_id" class="form-select" id="income-category-select">
                    <option value="">No category</option>
                    {% for cat in income_categories %}
                    <option value="{{ cat.id }}" {{ 'selected' if rec and rec.type == 'income' and rec.category_id == cat.id }}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3 d-none" id="expense-category-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="expense-category-select">
                    <option value="">No category</option>
                    {% for cat in expense_categories %}
                    <option value="{{ cat.id }}" {{ 'selected' if rec and rec.type == 'expense' and rec.category_id == cat.id }}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3" id="client-group">
                <label class="form-label">Client (optional)</label>
                <select name="client_id" class="form-select">
                    <option value="">No client</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}" {{ 'selected' if rec and rec.client_id == client.id }}>{{ client.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Frequency</label>
                <select name="frequency" class="form-select" required>
                    <option value="weekly" {{ 'selected' if rec and rec.frequency == 'weekly' }}>Weekly</option>
                    <option value="biweekly" {{ 'selected' if rec and rec.frequency == 'biweekly' }}>Biweekly</option>
                    <option value="monthly" {{ 'selected' if rec and rec.frequency == 'monthly' else 'selected' if not rec }}>Monthly</option>
                    <option value="yearly" {{ 'selected' if rec and rec.frequency == 'yearly' }}>Yearly</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Next Date</label>
                <input type="date" name="next_date" class="form-control" required
                    value="{{ rec.next_date.strftime('%Y-%m-%d') if rec else '' }}">
            </div>

            <div class="mb-3">
                <label class="form-label">Notes (optional)</label>
                <textarea name="notes" class="form-control" rows="2">{{ rec.notes if rec and rec.notes else '' }}</textarea>
            </div>

            <button type="submit" class="btn btn-game w-100">
                <i class="bi bi-check-lg me-1"></i> {{ 'Update' if rec else 'Create' }} Recurring Transaction
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const incomeCatGroup = document.getElementById('income-category-group');
const expenseCatGroup = document.getElementById('expense-category-group');
const incomeCatSelect = document.getElementById('income-category-select');
const expenseCatSelect = document.getElementById('expense-category-select');
const clientGroup = document.getElementById('client-group');

function toggleType() {
    const isIncome = document.getElementById('type_income').checked;
    if (isIncome) {
        incomeCatGroup.classList.remove('d-none');
        expenseCatGroup.classList.add('d-none');
        clientGroup.classList.remove('d-none');
        incomeCatSelect.name = 'category_id';
        expenseCatSelect.removeAttribute('name');
    } else {
        incomeCatGroup.classList.add('d-none');
        expenseCatGroup.classList.remove('d-none');
        clientGroup.classList.add('d-none');
        expenseCatSelect.name = 'category_id';
        incomeCatSelect.removeAttribute('name');
    }
}

// Initialize on page load
toggleType();

// Set today's date if empty
const dateInput = document.querySelector('input[name="next_date"]');
if (!dateInput.value) {
    dateInput.value = new Date().toISOString().split('T')[0];
}
</script>
{% endblock %}
